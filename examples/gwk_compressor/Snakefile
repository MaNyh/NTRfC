from snakemake.utils import validate
import pyvista as pv
from ntrfc.utils.filehandling.read_datafiles import yaml_dict_read
from ntrfc.utils.filehandling.read_mesh import load_mesh

#todo move this snakepipe to according dir in sourcecode

configfile : "casesettings.yaml"
validate(config,"config.schema.yaml")
basedir = workflow.current_basedir

rule profile_from_pointcloud:
    input:
        "00_resources/profile_pointcloud.txt"
    output:
        "01_geometry/sortedPoints.txt", "01_geometry/psPoly.vtk", "01_geometry/ssPoly.vtk", "01_geometry/midsPoly.vtk", "01_geometry/geometry_paras.yml"
    run:
        from ntrfc.preprocessing.geometry_creation.profile_pointcloud import generate_profile_pointcloud_geometry

        generate_profile_pointcloud_geometry(config["blade"],basedir)


rule create_2d_domain:
    input:
        "01_geometry/sortedPoints.txt", "01_geometry/psPoly.vtk", "01_geometry/ssPoly.vtk", "01_geometry/midsPoly.vtk", "01_geometry/geometry_paras.yml"
    output:
        "02_domain/inlet_2d.vtk","02_domain/outlet_2d.vtk","02_domain/y_upper_2d.vtk","02_domain/y_lower_2d.vtk",
        "02_domain/ogridline_2d.vtk"
    run:
        from ntrfc.preprocessing.mesh_creation.domain_creation import create_2d_domain

        sortedPoints_fpath = input[0]
        psPoly_fpath = input[1]
        ssPoly_fpath = input[2]
        midsPoly_fpath = input[3]
        geometry_paras_fpath = input[4]

        psPoly = load_mesh(psPoly_fpath)
        ssPoly = load_mesh(ssPoly_fpath)
        midsPoly = load_mesh(midsPoly_fpath)
        geometry_paras = yaml_dict_read(geometry_paras_fpath)

        create_2d_domain(config["blade"],basedir,midsPoly,ssPoly,psPoly)


"""
rule profile_from_naca:
#    input:
#        "input/helloworld.txt"
    output:
        "01_geometry/sortedPoints.txt", "01_geometry/psPoly.vtk", "01_geometry/ssPoly.vtk", "01_geometry/midsPoly.vtk", "01_geometry/geometry_paras.yml"
    shell:
        "python helloworld.py"


rule profile_from_parsec:
#    input:
#        "input/helloworld.txt"
    output:
        "01_geometry/sortedPoints.txt", "01_geometry/psPoly.vtk", "01_geometry/ssPoly.vtk", "01_geometry/midsPoly.vtk", "01_geometry/geometry_paras.yml"
    shell:
        "python helloworld.py"
"""
